<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Duhhvana</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <!-- Sound Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        /* --- Basic Setup & Retro Feel --- */
        html, body {
            height: 100%;
            margin: 0;
            overflow: hidden;
        }
        body {
            background-color: #1a1a2e;
            color: #e0e0e0;
            font-family: 'Press Start 2P', cursive;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            box-sizing: border-box;
            position: relative; 
        }

        .game-wrapper {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 20px;
            width: 100%;
            height: 100%;
            padding: 1rem;
            box-sizing: border-box;
        }

        /* --- Game Container --- */
        #game-container {
            border: 4px solid #0f3460;
            box-shadow: 0 0 20px #0f3460, inset 0 0 15px rgba(15, 52, 96, 0.7);
            background-color: #000;
            position: relative;
            width: 800px; /* Fixed internal width */
            height: 600px; /* Fixed internal height */
            touch-action: none;
        }

        #game-container.shake { animation: shake 0.4s; }
        @keyframes shake {
          10%, 90% { transform: translate3d(-1px, 0, 0); }
          20%, 80% { transform: translate3d(2px, 0, 0); }
          30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
          40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        canvas {
            display: block;
            background: #0d1117;
            image-rendering: pixelated;
            position: absolute;
            top: 0; left: 0;
            width: 100%;
            height: 100%;
        }

        #ui-panel { text-align: left; width: 250px; flex-shrink: 0; padding-left: 20px; }
        #branding { font-size: 1.2rem; color: #fff; text-align: center; margin-bottom: 20px; text-shadow: 2px 2px 0px #e94560; }
        #score-display, #leaderboard h2, #controls-panel h2 { color: #e94560; font-size: 1.2rem; margin-bottom: 10px; }
        #leaderboard, #controls-panel { margin-top: 20px; }
        #high-scores-list { list-style-type: none; padding: 0; font-size: 0.8rem; height: 150px; overflow-y: auto; }
        #high-scores-list li { padding: 4px 0; border-bottom: 1px dashed #0f3460; }
        
        .toggle-button { font-family: 'Press Start 2P', cursive; font-size: 0.8rem; background: var(--border-color); color: var(--text-color); border: none; padding: 8px 12px; cursor: pointer; margin-top: 10px; }
        
        /* --- Overlays (Loading/Modals) --- */
        .game-overlay {
            position: absolute; 
            top: 0; left: 0; right: 0; bottom: 0;
            display: flex;
            align-items: center; justify-content: center; text-align: center;
            background-color: rgba(26, 26, 46, 0.95);
            z-index: 100;
            padding: 20px;
            box-sizing: border-box;
        }
        #loading-screen { z-index: 101; cursor: pointer; }
        .overlay-content { max-width: 90%; }
        .overlay-content h2 { color: #e94560; font-size: 1.5rem; margin-bottom: 20px; }
        .ethos-text { font-size: 1rem; line-height: 1.6; margin-bottom: 40px; }
        .start-text { font-size: 1.2rem; color: #fff; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        #message-modal, #duhhvana-reward-modal { display: none; }
        #high-score-form, #win-high-score-form { margin-top: 15px; }
        #player-name-input, #win-player-name-input { font-family: 'Press Start 2P', cursive; background-color: #1a1a2e; color: #fff; border: 2px solid #0f3460; padding: 10px; font-size: 1rem; width: 70%; text-align: center; }
        #high-score-form button, #win-high-score-form button { margin-top: 10px; }
        .modal-buttons button { font-family: 'Press Start 2P', cursive; font-size: 1rem; padding: 15px 25px; background-color: #e94560; color: #fff; border: 2px solid #fff; cursor: pointer; transition: background-color 0.2s, color 0.2s; margin: 5px; }
        
        #touch-controls {
            position: fixed; bottom: 0; left: 0; width: 100%;
            padding: 20px; box-sizing: border-box; display: none;
            justify-content: space-between; align-items: flex-end;
            user-select: none; z-index: 102;
        }
        .touch-dpad { display: flex; gap: 10px; }
        .touch-button { width: 60px; height: 60px; background-color: rgba(255, 255, 255, 0.2); border: 2px solid rgba(255, 255, 255, 0.4); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; color: white; font-family: sans-serif; }
        #touch-shoot { width: 80px; height: 80px; }
        
        @media (max-width: 1100px) {
            .game-wrapper { flex-direction: column; align-items: center; }
            #ui-panel { width: 100%; max-width: 400px; margin-top: 20px; text-align: center; padding-left: 0; }
        }
        @media (max-width: 820px) {
            body { padding: 0; }
            .game-wrapper { gap: 0; }
            #game-container { width: 100%; height: 100%; max-width: none; border: none; }
            #ui-panel { display: none; }
        }
        @media (max-width: 768px) and (pointer: coarse) {
            #touch-controls-toggle { display: block !important; }
        }
    </style>
</head>
<body>
    <div class="game-wrapper">
        <div id="game-container">
            <div id="loading-screen" class="game-overlay">
                <div class="overlay-content">
                    <h2>A Sarcgasm.com Production</h2>
                    <p class="ethos-text">In a world saturated with information, true bliss is found in the cramped cocoon of curated ignorance. Your mission is to violently reject objective reality and build your own echo chamber, one comforting lie at a time. Prepare for... DUHHVANA.</p>
                    <p class="start-text" id="loading-status">Click or Tap anywhere to begin...</p>
                </div>
            </div>
            <canvas id="gameCanvas"></canvas>
            <div id="message-modal" class="game-overlay"> ... </div>
            <div id="duhhvana-reward-modal" class="game-overlay"> ... </div>
        </div>
        <div id="ui-panel">
            <div id="branding">sarcgasm.com</div>
            <div id="score-display">SCORE: 0</div>
            <div id="leaderboard"><h2>Leaderboard</h2><ol id="high-scores-list"></ol></div>
            <div id="controls-panel">
                <button class="toggle-button" id="touch-controls-toggle" style="display: none;">Toggle Controls</button>
            </div>
        </div>
    </div>
    <div id="touch-controls">
        <div class="touch-dpad">
            <div class="touch-button" id="touch-left">‹</div>
            <div class="touch-button" id="touch-right">›</div>
        </div>
        <div class="touch-button" id="touch-shoot">◎</div>
        <div class="touch-button" id="touch-up">⇡</div>
    </div>

    <script>
        window.onload = function() {
            const gameContainer = document.getElementById('game-container');
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');
            
            let GAME_WIDTH = 800; let GAME_HEIGHT = 600;
            canvas.width = GAME_WIDTH; canvas.height = GAME_HEIGHT;

            function resizeGame() { /* ... unchanged ... */ }
            resizeGame();
            window.addEventListener('resize', resizeGame);
            
            const INTERNAL_WIDTH = 800; const INTERNAL_HEIGHT = 600;

            const GRAVITY = 0.5, PLAYER_SPEED = 5, JUMP_FORCE = -12, PROJECTILE_SPEED = 10, OBJECT_SPAWN_RATE = 120, MAX_HIGH_SCORES = 5;
            const truthsList = [ "PUTIN RIDES HORSES BARE-CHESTED", "WATER IS WET", "EARTH IS (MOSTLY) ROUND", "GRAVITY PULLS YOU DOWN", "THE SUN IS A STAR", "DOGS BARK", "FIRE IS HOT", "ICE IS COLD", "SPIDERS HAVE 8 LEGS", "TREES PRODUCE OXYGEN", "TRUTH IS A PROCESS", "THE GREAT WALL IS IN CHINA", "BEWARE CONFIRMATION BIAS", "THE UNIVERSE IS BIG", "CLMATE CHANGE IS REAL", "THIS GAME IS FUNNY AF" ];
            const liesList = [ "THE EARTH IS FLAT", "VACCINES CAUSE AUTISM", "ALTERNATIVE FACTS ARE VALID", "ELON MUSK IS NOT A NAZI", "JEFF BEZOS IS HANDSOME", "THE MOON LANDING WAS FAKE", "BIRDS AREN'T REAL", "CHOCOLATE IS A VEGETABLE", "TRICKLE-DOWN ECONOMICS WORKS", "5G TOWERS SPREAD VIRUSES", "DIET SODA IS HEALTHY", "READING TERMS AND CONDITIONS", "I'LL START MY DIET TOMORROW", "I AM ALWAYS RIGHT", "THIS IS THE FINAL DRAFT", "I READ THE TERMS OF SERVICE" ];
            const blockColors = ['#B22234', '#FFFFFF', '#3C3B6E'];
            let keys = {}, projectiles = [], fallingObjects = [], platforms = [], frameCount = 0, gameOver = false, gameWon = false, score = 0, audioStarted = false;

            const soundFiles = {
                fire: 'sounds/trump_fakenewsmedia.mp3', jump: 'sounds/trump_jumpingnoise_mockingtrans.mp3',
                grunt: 'sounds/trump_cantdoit.mp3', truthLand: 'sounds/trump_grabembythepussy.mp3',
                lieLand: 'sounds/trump_youcandoanything.mp3', truthShot: 'sounds/trump_radicallunatics.mp3',
                lieShot: 'sounds/trump_disrespectful.mp3', gameOver: '', duhhvana: '',
                bgm: 'sounds/bgm.mp3', winMusic: 'sounds/win_music.mp3', loseMusic: 'sounds/lose_music.mp3'
            };

            const fallbackSounds = { /* ... unchanged ... */ };
            
            const players = new Tone.Players(soundFiles, {
                onload: () => console.log('Custom sounds loaded!'),
                onerror: (error) => console.error("A custom sound failed to load: ", error),
            }).toDestination();
            players.crossOrigin = "anonymous";
            
            // --- NEW BGM and Music Players ---
            const bgmPlayer = new Tone.Player({url: soundFiles.bgm, loop: true, autostart: false, crossOrigin: "anonymous"}).toDestination();
            const winPlayer = new Tone.Player({url: soundFiles.winMusic, autostart: false, crossOrigin: "anonymous"}).toDestination();
            const losePlayer = new Tone.Player({url: soundFiles.loseMusic, autostart: false, crossOrigin: "anonymous"}).toDestination();

            function playSound(soundName) {
                if (!audioStarted) return;
                switch(soundName) {
                    case 'fire': fallbackSounds.fire.triggerAttackRelease('C5', '8n'); break;
                    /* ... all other cases ... */
                }
                if (players.has(soundName) && players.player(soundName).loaded) {
                    players.player(soundName).start();
                }
            }
            
            const player = { /* ... unchanged ... */ };
            
            // --- All other game functions (player.draw, player.update, etc) remain the same ---

            function triggerGameOver(reason) {
                if (gameOver) return;
                gameOver = true;
                bgmPlayer.stop();
                if (losePlayer.loaded) losePlayer.start(); else playSound('gameOver');
                triggerScreenShake();
                showModal('Game Over!', reason || 'You faced reality.');
            }
            
            function triggerGameWin() {
                if (gameWon) return;
                gameWon = true;
                bgmPlayer.stop();
                if (winPlayer.loaded) winPlayer.start(); else playSound('duhhvana');
                const highScores = getHighScores();
                const isHighScore = highScores.length < MAX_HIGH_SCORES || score > highScores[highScores.length - 1]?.score;
                document.getElementById('win-high-score-form').style.display = isHighScore ? 'block' : 'none';
                document.getElementById('duhhvana-reward-modal').style.display = 'flex';
            }
            
            function resetGame() {
                /* ... unchanged, but add music handling ... */
                winPlayer.stop();
                losePlayer.stop();
                if(bgmPlayer.loaded) bgmPlayer.start();
                gameLoop();
            }

            // --- Event Listeners ---
            const loadingScreen = document.getElementById('loading-screen');
            const loadingStatus = document.getElementById('loading-status');
            function startGame(e) {
                e.preventDefault();
                loadingStatus.textContent = "Loading Sounds...";
                
                if (!audioStarted) {
                    Tone.start().then(() => Tone.loaded().then(() => {
                        audioStarted = true;
                        loadingScreen.style.display = 'none';
                        if(bgmPlayer.loaded) bgmPlayer.start();
                        resetGame();
                    }));
                }
            }
            loadingScreen.addEventListener('click', startGame, { once: true });
            loadingScreen.addEventListener('touchend', startGame, { once: true });
            
            // --- Controls Toggle ---
            const touchControlsToggle = document.getElementById('touch-controls-toggle');
            const touchControls = document.getElementById('touch-controls');
            touchControlsToggle.addEventListener('click', () => {
                const isVisible = touchControls.style.display === 'flex';
                touchControls.style.display = isVisible ? 'none' : 'flex';
            });
            
            // Swipe and Tap controls on game canvas
            let touchStartX = 0, touchStartY = 0;
            gameContainer.addEventListener('touchstart', (e) => { touchStartX = e.changedTouches[0].screenX; touchStartY = e.changedTouches[0].screenY; }, { passive: true });
            gameContainer.addEventListener('touchend', (e) => { /*... swipe/tap logic ...*/ });
        };
    </script>
</body>
</html>
