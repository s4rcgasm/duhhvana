<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Duhhvana</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            overflow: hidden;
        }
        body {
            background-color: #1a1a2e;
            color: #e0e0e0;
            font-family: 'Press Start 2P', cursive;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            box-sizing: border-box;
            position: relative; 
        }
        .game-wrapper {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 20px;
            width: 100%;
            height: 100%;
            padding: 1rem;
            box-sizing: border-box;
        }
        #game-container {
            border: 4px solid #0f3460;
            box-shadow: 0 0 20px #0f3460, inset 0 0 15px rgba(15, 52, 96, 0.7);
            background-color: #000;
            position: relative;
            width: 800px;
            height: 600px;
            touch-action: none;
        }
        #game-container.shake { animation: shake 0.4s; }
        @keyframes shake {
          10%, 90% { transform: translate3d(-1px, 0, 0); }
          20%, 80% { transform: translate3d(2px, 0, 0); }
          30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
          40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        canvas {
            display: block;
            background: #0d1117;
            image-rendering: pixelated;
            position: absolute;
            top: 0; left: 0;
            width: 100%;
            height: 100%;
        }
        #ui-panel { text-align: left; width: 250px; flex-shrink: 0; padding-left: 20px; }
        #branding { font-size: 1.2rem; color: #fff; text-align: center; margin-bottom: 20px; text-shadow: 2px 2px 0px #e94560; }
        #score-display, #leaderboard h2, #controls-panel h2 { color: #e94560; font-size: 1.2rem; margin-bottom: 10px; }
        #leaderboard, #controls-panel { margin-top: 20px; }
        #high-scores-list { list-style-type: none; padding: 0; font-size: 0.8rem; height: 150px; overflow-y: auto; }
        #high-scores-list li { padding: 4px 0; border-bottom: 1px dashed #0f3460; }
        .toggle-button { font-family: 'Press Start 2P', cursive; font-size: 0.8rem; background: var(--border-color); color: var(--text-color); border: none; padding: 8px 12px; cursor: pointer; margin-top: 10px; }
        .game-overlay {
            position: absolute; 
            top: 0; left: 0; right: 0; bottom: 0;
            display: flex;
            align-items: center; justify-content: center; text-align: center;
            background-color: rgba(26, 26, 46, 0.95);
            z-index: 100;
            padding: 20px;
            box-sizing: border-box;
        }
        #loading-screen { z-index: 101; cursor: pointer; }
        .overlay-content { max-width: 90%; }
        .overlay-content h2 { color: #e94560; font-size: 1.5rem; margin-bottom: 20px; }
        .ethos-text { font-size: 1rem; line-height: 1.6; margin-bottom: 40px; }
        .start-text { font-size: 1.2rem; color: #fff; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        #message-modal, #duhhvana-reward-modal { display: none; }
        #player-name-input, #win-player-name-input { font-family: 'Press Start 2P', cursive; background-color: #1a1a2e; color: #fff; border: 2px solid #0f3460; padding: 10px; font-size: 1rem; width: 70%; text-align: center; }
        .modal-buttons button { font-family: 'Press Start 2P', cursive; font-size: 1rem; padding: 15px 25px; background-color: #e94560; color: #fff; border: 2px solid #fff; cursor: pointer; transition: background-color 0.2s, color 0.2s; margin: 5px; }
        #touch-controls {
            position: fixed; bottom: 0; left: 0; width: 100%;
            padding: 20px; box-sizing: border-box;
            display: flex; justify-content: space-between; align-items: flex-end;
            user-select: none; z-index: 102;
        }
        .touch-dpad { display: flex; gap: 10px; }
        .touch-button { width: 60px; height: 60px; background-color: rgba(255, 255, 255, 0.2); border: 2px solid rgba(255, 255, 255, 0.4); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; color: white; font-family: sans-serif; }
        #touch-shoot { width: 80px; height: 80px; }
        @media (max-width: 820px) {
            body { padding: 0; }
            .game-wrapper { gap: 0; }
            #game-container { width: 100%; height: 100%; border: none; }
            #ui-panel { display: none; }
            #touch-controls { display: flex; }
        }
    </style>
</head>
<body>
    <div class="game-wrapper">
        <div id="game-container">
            <div id="loading-screen" class="game-overlay">
                <div class="overlay-content">
                    <h2>A Sarcgasm.com Production</h2>
                    <p class="ethos-text">In a world saturated with information...</p>
                    <p class="start-text" id="loading-status">Click or Tap anywhere to begin...</p>
                </div>
            </div>
            <canvas id="gameCanvas"></canvas>
        </div>
        <div id="ui-panel">
            <div id="branding">sarcgasm.com</div>
            <div id="score-display">SCORE: 0</div>
            <div id="leaderboard"><h2>Leaderboard</h2><ol id="high-scores-list"></ol></div>
            <div id="controls-panel">
                <button class="toggle-button" id="touch-controls-toggle">Toggle Controls</button>
            </div>
        </div>
    </div>
    <div id="touch-controls">
        <div class="touch-dpad">
            <div class="touch-button" id="touch-left">‹</div>
            <div class="touch-button" id="touch-right">›</div>
        </div>
        <div class="touch-button" id="touch-shoot">◎</div>
        <div class="touch-button" id="touch-up">⇡</div>
    </div>

<script>
window.onload = function() {
    const gameContainer = document.getElementById('game-container');
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    canvas.width = 800;
    canvas.height = 600;

    // --- START / AUDIO HANDLER (ADDED) ---
    const loadingScreen = document.getElementById('loading-screen');
    let audioStarted = false;

    function startGameHandler(e) {
        // prevent default for touch events so they don't also fire other handlers
        if (e && e.preventDefault) try { e.preventDefault(); } catch(_) {}

        // If Tone.js is used in your game, start audio context on user gesture
        if (window.Tone && !audioStarted) {
            // Tone.start returns a promise; ignore result here but ensures audio can play.
            Tone.start().then(() => { audioStarted = true; console.log('Audio started via Tone.'); })
                .catch(() => { audioStarted = true; console.log('Tone.start() failed or was blocked'); });
        }

        // hide the overlay and allow the rest of the game to run
        loadingScreen.style.display = 'none';

        // if you have any init/reset logic, call it here.
        // e.g. resetGame(); or start your game loop if paused.
        console.log('Game start triggered by user input.');
    }

    // Support pointer (mouse/stylus), click (fallback), and touchend (mobile)
    loadingScreen.addEventListener('pointerdown', startGameHandler, { once: true });
    loadingScreen.addEventListener('click', startGameHandler, { once: true });
    loadingScreen.addEventListener('touchend', startGameHandler, { once: true });

    // --- EXISTING INPUT LOGIC (unchanged) ---
    let keys = {}; // unified keys object

    // Keyboard
    window.addEventListener('keydown', e => { keys[e.code] = true; });
    window.addEventListener('keyup', e => { keys[e.code] = false; });

    // Touch buttons
    function bindTouchButton(id, key) {
        const el = document.getElementById(id);
        el.addEventListener('touchstart', e => { e.preventDefault(); keys[key] = true; }, { passive: false });
        el.addEventListener('touchend', e => { e.preventDefault(); keys[key] = false; }, { passive: false });
    }
    bindTouchButton('touch-left', 'ArrowLeft');
    bindTouchButton('touch-right', 'ArrowRight');
    bindTouchButton('touch-up', 'Space');
    bindTouchButton('touch-shoot', 'KeyZ');

    // Swipe/Tap
    let startX=0, startY=0, startTime=0;
    gameContainer.addEventListener('touchstart', e => {
        if (e.target.closest('#touch-controls')) return;
        startX = e.changedTouches[0].screenX;
        startY = e.changedTouches[0].screenY;
        startTime = Date.now();
    }, { passive: true });
    gameContainer.addEventListener('touchend', e => {
        if (e.target.closest('#touch-controls')) return;
        const dx = e.changedTouches[0].screenX - startX;
        const dy = e.changedTouches[0].screenY - startY;
        const dt = Date.now() - startTime;
        const threshold = 30;
        if (Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > threshold) {
            if (dx > 0) keys['ArrowRight'] = true;
            else keys['ArrowLeft'] = true;
        } else if (dy < -threshold) {
            keys['Space'] = true;
        } else if (dt < 200) {
            keys['KeyZ'] = true;
        }
        setTimeout(() => { keys = {}; }, 100);
    }, { passive: true });

    // Toggle controls
    document.getElementById('touch-controls-toggle').addEventListener('click', () => {
        const tc = document.getElementById('touch-controls');
        tc.style.display = tc.style.display === 'none' ? 'flex' : 'none';
    });

    // GAME LOOP (minimal example)
    function gameLoop() {
        ctx.clearRect(0,0,canvas.width,canvas.height);
        // Here you’d use keys[] to move/shoot
        requestAnimationFrame(gameLoop);
    }
    gameLoop();
};
</script>
</body>
</html>
